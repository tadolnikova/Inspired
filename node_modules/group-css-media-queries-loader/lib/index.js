"use strict";
var __importDefault =
  (this && this.__importDefault) ||
  function (mod) {
    return mod && mod.__esModule ? mod : { default: mod };
  };
const postcss_1 = __importDefault(require("postcss"));
const loader_utils_1 = require("loader-utils");
const schema_utils_1 = __importDefault(require("schema-utils"));
const source_map_1 = __importDefault(require("./source-map"));
const schema_json_1 = __importDefault(require("./schema.json"));
const GroupCssMediaQueriesPostCssPlugin = require("./group-css-media-queries");
function GroupCssMediaQueriesLoader(content, prevSourceMap, additionalData) {
  const loaderOptions = (0, loader_utils_1.getOptions)(this) || {};
  (schema_utils_1.default.validate || schema_utils_1.default)(
    schema_json_1.default,
    loaderOptions,
    {
      name: "group-css-media-queries-loader",
    }
  );
  const callback = this.async();
  const sourceMap = (0, source_map_1.default)(loaderOptions, () => this);
  const pipeline = (0, postcss_1.default)(GroupCssMediaQueriesPostCssPlugin);
  pipeline
    .process(content, {
      from: (0, loader_utils_1.getRemainingRequest)(this).split("!").pop(),
      to: (0, loader_utils_1.getCurrentRequest)(this).split("!").pop(),
      map: sourceMap.getOptions(prevSourceMap),
    })
    .then((result) =>
      callback(null, result.css, sourceMap.onResult(result), additionalData)
    )
    .catch(callback);
}
module.exports = GroupCssMediaQueriesLoader;
